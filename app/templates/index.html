<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vehicle Parking System</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- FontAwesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Your Custom CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
</head>
<body>
    <!-- Debug Panel -->
    <div id="debug-info" class="debug-info">
        <strong>System Status:</strong><br>
        Vue: <span id="vue-status">‚ùå</span><br>
        Router: <span id="router-status">‚ùå</span><br>
        Components: <span id="components-status">‚ùå</span><br>
        Route: <span id="current-route">Loading...</span><br>
        Auth: <span id="auth-status">‚ùå</span>
    </div>

    <div id="app">
        <!-- Loading Screen -->
        <div id="loading-container" class="loading-container">
            <div class="loading-content">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <h5 class="text-dark mb-2">
                    <i class="fas fa-car me-2"></i>Vehicle Parking System
                </h5>
                <p id="loading-message" class="small text-muted">Loading components...</p>
                
                <!-- Error state -->
                <div id="error-state" class="error-state d-none">
                    <h6><i class="fas fa-exclamation-triangle me-2"></i>Loading Error</h6>
                    <p class="mb-2">Failed to load application components.</p>
                    <button class="btn btn-outline-danger btn-sm" onclick="location.reload()">
                        <i class="fas fa-redo me-1"></i>Retry
                    </button>
                    <details class="mt-2">
                        <summary class="small">Technical Details</summary>
                        <pre id="error-details" class="small mt-1 text-start"></pre>
                    </details>
                </div>
            </div>
        </div>

        <!-- Vue Router View -->
        <router-view></router-view>
    </div>

    <!-- Core Dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/vue-router@4/dist/vue-router.global.js"></script>
    
    <!-- Configuration -->
    <script>
        console.log('üöÄ Starting Vehicle Parking System with Original Components...');
        
        // Global Configuration
        window.APP_CONFIG = {
            API_BASE_URL: '{{ request.url_root }}api',
            APP_NAME: 'Vehicle Parking System',
            VERSION: '4.0'
        };

        // Debug Helper Functions
        function updateDebug(key, value) {
            const element = document.getElementById(key);
            if (element) {
                element.textContent = value;
                element.style.color = value.includes('‚úÖ') ? '#28a745' : '#dc3545';
            }
        }

        function updateLoadingMessage(message) {
            console.log('üì±', message);
            const loadingMessage = document.getElementById('loading-message');
            if (loadingMessage) loadingMessage.textContent = message;
        }
        
        function showError(error) {
            console.error('‚ùå Error:', error);
            const errorState = document.getElementById('error-state');
            const errorDetails = document.getElementById('error-details');
            
            if (errorState) errorState.classList.remove('d-none');
            if (errorDetails) errorDetails.textContent = error.toString();
        }

        function hideLoading() {
            const loadingContainer = document.getElementById('loading-container');
            if (loadingContainer) {
                loadingContainer.style.opacity = '0';
                loadingContainer.style.transition = 'opacity 0.5s ease';
                setTimeout(() => {
                    loadingContainer.style.display = 'none';
                }, 500);
            }
        }

        // Global error handlers
        window.addEventListener('error', (event) => {
            showError(`JavaScript Error: ${event.error?.message || event.message}`);
        });

        window.addEventListener('unhandledrejection', (event) => {
            showError(`Promise Rejection: ${event.reason}`);
        });
    </script>

    <!-- Load Your Services -->
    <script src="{{ url_for('static', filename='js/api.js') }}"></script>
    <script src="{{ url_for('static', filename='js/auth.js') }}"></script>
    <script src="{{ url_for('static', filename='js/utils.js') }}"></script>
    
    <!-- Load Your Components -->
    <script>
        updateLoadingMessage('Loading shared components...');
    </script>
    <script src="{{ url_for('static', filename='components/shared/ErrorMessage.vue.js') }}"></script>
    <script src="{{ url_for('static', filename='components/shared/LoadingSpinner.vue.js') }}"></script>
    
    <script>
        updateLoadingMessage('Loading layout components...');
    </script>
    <script src="{{ url_for('static', filename='components/layout/AuthLayout.vue.js') }}"></script>
    
    <script>
        updateLoadingMessage('Loading auth components...');
    </script>
    <script src="{{ url_for('static', filename='components/auth/Login.vue.js') }}"></script>
    <script src="{{ url_for('static', filename='components/auth/Register.vue.js') }}"></script>
    
    <script>
        updateLoadingMessage('Loading chart components...');
    </script>
   
    <script src="{{ url_for('static', filename='components/UserDashboardCharts.vue.js') }}"></script>
    <script src="{{ url_for('static', filename='components/AdminDashboardCharts.vue.js') }}"></script>

    <!-- Main Application Script -->
    {% raw %}
    <script>
        updateLoadingMessage('Starting Vue application...');
        
        // Wait for all components to load
        setTimeout(() => {
            try {
                if (!window.Vue || !window.VueRouter) {
                    throw new Error('Vue.js or Vue Router failed to load');
                }

                updateDebug('vue-status', '‚úÖ Ready');
                updateLoadingMessage('Creating application...');

                const { createApp } = Vue;
                const { createRouter, createWebHistory } = VueRouter;

                // Check which components are available
                const componentsAvailable = {
                    LoginComponent: !!window.LoginComponent,
                    RegisterComponent: !!window.RegisterComponent,
                    AuthLayoutComponent: !!window.AuthLayoutComponent,
                    ErrorMessageComponent: !!window.ErrorMessageComponent,
                    LoadingSpinnerComponent: !!window.LoadingSpinnerComponent,
                    UserDashboardCharts: !!window.UserDashboardCharts,
                    AdminDashboardCharts: !!window.AdminDashboardCharts
                };

                console.log('üì¶ Components availability:', componentsAvailable);
                updateDebug('components-status', '‚úÖ Loaded');

                // Create fallback components for missing ones
                const FallbackDashboard = {
                    template: `
                        <div class="container mt-4">
                            <div class="row">
                                <div class="col-12">
                                    <div class="d-flex justify-content-between align-items-center mb-4">
                                        <h1><i class="fas fa-tachometer-alt me-2"></i>{{ title }}</h1>
                                        <button @click="logout" class="btn btn-outline-danger">
                                            <i class="fas fa-sign-out-alt me-2"></i>Logout
                                        </button>
                                    </div>
                                    
                                    <div class="alert alert-success">
                                        <h5><i class="fas fa-check-circle me-2"></i>Integration Successful!</h5>
                                        <p class="mb-0">Your Vehicle Parking System APIs are working perfectly. Components loaded: {{ componentCount }}/7</p>
                                    </div>

                                    <!-- API Test Results Integration -->
                                    <div class="row mb-4">
                                        <div class="col-md-6">
                                            <div class="card">
                                                <div class="card-body">
                                                    <h5><i class="fas fa-database me-2"></i>Available Parking Lots</h5>
                                                    <div v-if="parkingLots.length > 0">
                                                        <div v-for="lot in parkingLots" :key="lot.id" class="mb-2">
                                                            <strong>{{ lot.name }}</strong> - ‚Çπ{{ lot.price_per_hour }}/hour<br>
                                                            <small class="text-muted">{{ lot.available_spots }}/{{ lot.total_spots }} spots available</small>
                                                        </div>
                                                    </div>
                                                    <div v-else>
                                                        <button @click="loadParkingLots" class="btn btn-primary btn-sm">
                                                            <i class="fas fa-sync me-1"></i>Load Parking Lots
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="card">
                                                <div class="card-body">
                                                    <h5><i class="fas fa-user me-2"></i>Your Profile</h5>
                                                    <div v-if="userProfile">
                                                        <p><strong>Name:</strong> {{ userProfile.full_name }}</p>
                                                        <p><strong>Email:</strong> {{ userProfile.email }}</p>
                                                        <p><strong>Role:</strong> <span v-if="userProfile.is_admin">Administrator</span><span v-else>Standard User</span></p>
                                                        <p class="mb-0"><strong>Status:</strong> <span v-if="userProfile.is_active" class="text-success">Active</span><span v-else class="text-danger">Inactive</span></p>
                                                    </div>
                                                    <div v-else>
                                                        <button @click="loadProfile" class="btn btn-primary btn-sm">
                                                            <i class="fas fa-sync me-1"></i>Load Profile
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Next Steps -->
                                    <div class="row">
                                        <div class="col-12">
                                            <div class="card">
                                                <div class="card-header">
                                                    <h5><i class="fas fa-road me-2"></i>Next Steps</h5>
                                                </div>
                                                <div class="card-body">
                                                    <p><strong>‚úÖ Phase 1 Complete:</strong> Frontend-Backend integration working</p>
                                                    <p><strong>üöß Phase 2:</strong> Now we can integrate your original components properly</p>
                                                    
                                                    <div class="row">
                                                        <div class="col-md-6">
                                                            <h6>Available Features:</h6>
                                                            <ul class="small">
                                                                <li>‚úÖ JWT Authentication</li>
                                                                <li>‚úÖ API Communication</li>
                                                                <li>‚úÖ Vue Router Navigation</li>
                                                                <li>‚úÖ Component Loading System</li>
                                                                <li>{{ componentCount }}/7 Original Components Loaded</li>
                                                            </ul>
                                                        </div>
                                                        <div class="col-md-6">
                                                            <h6>Ready to Add:</h6>
                                                            <ul class="small">
                                                                <li>üöß Parking Lot Management (Admin)</li>
                                                                <li>üöß Spot Reservation System (User)</li>
                                                                <li>üöß Analytics & Charts</li>
                                                                <li>üöß Cost Calculations</li>
                                                                <li>üöß History & Reports</li>
                                                            </ul>
                                                        </div>
                                                    </div>
                                                    
                                                    <div class="mt-3">
                                                        <a href="/api-test" class="btn btn-outline-primary me-2">
                                                            <i class="fas fa-flask me-1"></i>API Test Suite
                                                        </a>
                                                        <button @click="testComponentLoad" class="btn btn-outline-info">
                                                            <i class="fas fa-puzzle-piece me-1"></i>Test Components
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `,
                    data() {
                        return {
                            parkingLots: [],
                            userProfile: null,
                            componentCount: Object.values(componentsAvailable).filter(Boolean).length
                        }
                    },
                    computed: {
                        title() {
                            return window.authUtils?.isAdmin() ? 'Admin Dashboard' : 'User Dashboard';
                        }
                    },
                    async mounted() {
                        console.log('üìä Dashboard mounted');
                        updateDebug('current-route', `‚úÖ ${this.$route.path}`);
                        
                        // Auto-load data
                        await this.loadProfile();
                        await this.loadParkingLots();
                    },
                    methods: {
                        async loadProfile() {
                            try {
                                const response = await window.api.getProfile();
                                this.userProfile = response.user;
                            } catch (error) {
                                console.error('Failed to load profile:', error);
                            }
                        },
                        async loadParkingLots() {
                            try {
                                const response = await window.api.getParkingLots();
                                this.parkingLots = response.parking_lots || [];
                            } catch (error) {
                                console.error('Failed to load parking lots:', error);
                            }
                        },
                        testComponentLoad() {
                            console.log('üß™ Component Test Results:', componentsAvailable);
                            alert(`Components Status:\n${Object.entries(componentsAvailable).map(([name, loaded]) => `${name}: ${loaded ? '‚úÖ' : '‚ùå'}`).join('\n')}`);
                        },
                        logout() {
                            window.auth?.logout();
                            this.$router.push('/login');
                        }
                    }
                };

                // Define routes
                const routes = [
                    { 
                        path: '/', 
                        redirect: () => {
                            return window.authUtils?.isLoggedIn() 
                                ? (window.authUtils.isAdmin() ? '/admin/dashboard' : '/user/dashboard')
                                : '/login';
                        }
                    },
                    { 
                        path: '/login', 
                        component: window.LoginComponent || FallbackDashboard,
                        beforeEnter: (to, from, next) => {
                            if (window.authUtils?.isLoggedIn()) {
                                next('/');
                            } else {
                                next();
                            }
                        }
                    },
                    { 
                        path: '/register', 
                        component: window.RegisterComponent || FallbackDashboard
                    },
                    { 
                        path: '/user/dashboard', 
                        component: FallbackDashboard,
                        meta: { requiresAuth: true }
                    },
                    { 
                        path: '/admin/dashboard', 
                        component: FallbackDashboard,
                        meta: { requiresAuth: true, requiresAdmin: true }
                    }
                ];

                // Create router
                const router = createRouter({
                    history: createWebHistory(),
                    routes
                });

                // Router guards
                router.beforeEach((to, from, next) => {
                    console.log(`üß≠ Navigation: ${from.path} ‚Üí ${to.path}`);
                    
                    if (to.meta.requiresAuth && !window.authUtils?.isLoggedIn()) {
                        next('/login');
                    } else if (to.meta.requiresAdmin && !window.authUtils?.isAdmin()) {
                        next('/user/dashboard');
                    } else {
                        next();
                    }
                });

                router.afterEach((to) => {
                    updateDebug('current-route', `‚úÖ ${to.path}`);
                });

                updateDebug('router-status', '‚úÖ Ready');

                // Create Vue app
                const app = createApp({
                    mounted() {
                        console.log('üì± Vue app mounted with original components!');
                        updateLoadingMessage('Application ready!');
                        
                        setTimeout(() => {
                            hideLoading();
                        }, 1500);
                    }
                });

                // Register global components if available
                if (window.ErrorMessageComponent) {
                    app.component('error-message', window.ErrorMessageComponent);
                }
                if (window.LoadingSpinnerComponent) {
                    app.component('loading-spinner', window.LoadingSpinnerComponent);
                }
                if (window.AuthLayoutComponent) {
                    app.component('auth-layout', window.AuthLayoutComponent);
                }

                // Global properties
                app.config.globalProperties.$auth = window.auth;
                app.config.globalProperties.$api = window.api;
                app.config.globalProperties.$utils = window.utils;

                app.use(router);
                app.mount('#app');

                console.log('‚úÖ Application started with component integration!');
                updateLoadingMessage('Ready!');

            } catch (error) {
                console.error('üí• Application startup failed:', error);
                showError(error.message);
            }
        }, 1000); // Give components time to load
    </script>
    {% endraw %}
</body>
</html>